<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ© - Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        body { background: #121212; color: white; font-family: 'Tajawal', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨Ø© - Ù…Ø±Ø¨Ø¹ Ù…Ø«Ø§Ù„ÙŠ */
        #game-container { width: 98vw; height: 98vw; max-width: 600px; max-height: 600px; position: relative; margin-top: 5px; }
        .board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); width: 100%; height: 100%; background: #cce5d6; border: 2px solid #333; box-shadow: 0 0 15px rgba(0,0,0,0.5); font-size: 8px; }
        
        /* Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
        .cell { border: 0.5px solid #7f8c8d; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; background: white; color: black; padding: 0; overflow: hidden; }
        .cell-header { width: 100%; height: 25%; border-bottom: 1px solid #333; margin-bottom: 2px; } /* Ø´Ø±ÙŠØ· Ø§Ù„Ù„ÙˆÙ† */
        .cell-name { font-weight: bold; font-size: 2.2vmin; line-height: 1; margin-top: 1px; }
        .cell-price { font-size: 2vmin; margin-top: auto; padding-bottom: 2px; }
        
        /* Ø§Ù„Ø²ÙˆØ§ÙŠØ§ ÙˆØ§Ù„Ù…Ø­Ø·Ø§Øª */
        .corner { background: #ffeaa7; display: flex; justify-content: center; align-items: center; font-size: 2.5vmin; font-weight: bold; }
        .station { background: #dfe6e9; }
        
        /* Ø§Ù„ÙˆØ³Ø· - Ø§Ù„ØµÙˆØ±Ø© */
        .center-box { 
            grid-column: 2 / 11; grid-row: 2 / 11; 
            background: #27ae60;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            /* ØµÙˆØ±Ø© SVG Ø«Ø§Ø¨ØªØ© Ù…Ù† ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§ */
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/Dhi_Qar_in_Iraq.svg');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            position: relative;
        }
        .center-overlay { background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; color: #f1c40f; font-size: 4vmin; font-weight: bold; box-shadow: 0 0 10px #f1c40f; }

        /* Ù‚Ø·Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .token { width: 3vmin; height: 3vmin; border-radius: 50%; border: 1px solid #fff; position: absolute; z-index: 10; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); transition: all 0.3s ease; top: 40%; left: 40%; }

        /* Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠ */
        #controls-area { width: 98%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; background: #2c3e50; padding: 10px; border-radius: 10px 10px 0 0; position: fixed; bottom: 0; box-sizing: border-box; }
        .btn { background: #e67e22; border: none; color: white; padding: 10px 15px; border-radius: 5px; font-weight: bold; font-family: inherit; font-size: 3.5vmin; }
        .btn-trade { background: #3498db; }
        
        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù‚Ø§ÙŠØ¶Ø© (Modal) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #2c3e50; padding: 15px; border-radius: 10px; width: 90%; max-width: 400px; color: white; display: flex; flex-direction: column; gap: 10px; max-height: 90vh; overflow-y: auto; }
        .trade-col { background: #34495e; padding: 10px; border-radius: 5px; margin: 5px 0; }
        .trade-title { color: #f1c40f; font-weight: bold; margin-bottom: 5px; display: block; }
        .prop-check { display: flex; align-items: center; gap: 5px; font-size: 12px; margin: 2px 0; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù„ÙƒÙŠØ© */
        .owner-strip { position: absolute; top: 0; left: 0; width: 100%; height: 3px; z-index: 5; }
    </style>
</head>
<body>

<div id="lobby" style="text-align: center; margin-top: 30vh;">
    <h1 style="color:#f1c40f;">ğŸ‘‘ Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
    <input id="p-name" placeholder="Ø§Ø³Ù…Ùƒ" style="padding:10px; border-radius:5px; border:none; margin:5px;">
    <input id="r-id" placeholder="Ø§Ù„ØºØ±ÙØ©" style="padding:10px; border-radius:5px; border:none; margin:5px;">
    <br>
    <button class="btn" onclick="start()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù…Ù„ÙƒØ©</button>
</div>

<div id="game-screen" style="display:none;">
    <div style="width:98%; display:flex; justify-content:space-between; padding:5px; font-size:3vmin;">
        <div id="turn-info">Ø§Ù„Ø¯ÙˆØ±: ...</div>
        <div id="money-info" style="color:#2ecc71; font-weight:bold;">ğŸ’° 1500$</div>
    </div>

    <div id="game-container">
        <div class="board" id="board">
            <div class="center-box">
                <div class="center-overlay">Ø°ÙŠ Ù‚Ø§Ø±</div>
            </div>
            </div>
    </div>

    <div id="controls-area">
        <button class="btn btn-trade" onclick="showTradeModal()">ğŸ¤ Ù…Ù‚Ø§ÙŠØ¶Ø©</button>
        <div id="dice-display" style="font-size: 6vmin; background:white; color:black; padding:2px 10px; border-radius:5px;">ğŸ²</div>
        <button class="btn" id="roll-btn" onclick="roll()">Ø§Ø±Ù…ÙŠ Ø§Ù„Ø²Ø§Ø±</button>
    </div>
</div>

<div id="trade-modal" class="modal">
    <div class="modal-content">
        <h3>ğŸ’° Ø¹Ù‚Ø¯ Ù…Ù‚Ø§ÙŠØ¶Ø©</h3>
        <select id="trade-target" style="width:100%; padding:8px; margin-bottom:10px;"></select>
        
        <div class="trade-col">
            <span class="trade-title">ğŸ“¤ Ø£Ù†Øª ØªÙ‚Ø¯Ù…:</span>
            <input type="number" id="offer-money" placeholder="Ù…Ø¨Ù„Øº Ù…Ø§Ù„ÙŠ" style="width:100px;">
            <div id="my-props-list"></div>
        </div>

        <div class="trade-col">
            <span class="trade-title">ğŸ“¥ Ø£Ù†Øª ØªØ·Ù„Ø¨:</span>
            <input type="number" id="want-money" placeholder="Ù…Ø¨Ù„Øº Ù…Ø§Ù„ÙŠ" style="width:100px;">
            <div id="target-props-list"></div>
        </div>

        <div style="display:flex; justify-content:space-between;">
            <button class="btn" style="background:#e74c3c" onclick="closeTrade()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn" style="background:#2ecc71" onclick="sendTrade()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let myName, myRoom, myColor = '#'+Math.floor(Math.random()*16777215).toString(16);
    let gameState = null;

    // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø±ÙŠØ·Ø© Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ---
    // color: ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆÙ†ØŒ group: Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    const colors = {
        brown: '#795548', lblue: '#81d4fa', pink: '#e91e63', orange: '#ff9800',
        red: '#f44336', yellow: '#ffeb3b', green: '#4caf50', dblue: '#3f51b5'
    };

    const zones = [
        {n:"Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", t:"corner"}, 
        {n:"Ø³ÙˆÙ‚ Ø§Ù„Ø´ÙŠÙˆØ® Ø§Ù„Ù‚Ø¯ÙŠÙ…", g:"brown", p:60}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹ÙƒÙŠÙƒØ©", g:"brown", p:60}, {n:"Ø¶Ø±ÙŠØ¨Ø©", t:"tax"}, {n:"ÙƒØ±Ø§Ø¬ Ø¨ØºØ¯Ø§Ø¯", t:"station", p:200}, 
        {n:"ÙƒØ±Ù…Ø© Ø¨Ù†ÙŠ Ø³Ø¹ÙŠØ¯", g:"lblue", p:100}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø§Ù„Ø·Ø§Ø±", g:"lblue", p:100}, {n:"Ø§Ù„ÙÙ‡ÙˆØ¯", g:"lblue", p:120}, 
        {n:"Ø³Ø¬Ù†", t:"corner"}, 
        {n:"Ø­ÙŠ Ø§Ù„ÙØ¯Ø§Ø¡", g:"pink", p:140}, {n:"Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡", t:"util", p:150}, {n:"Ø­ÙŠ Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡", g:"pink", p:140}, {n:"Ø­ÙŠ Ø§Ù„Ø´Ù…ÙˆØ®", g:"pink", p:160}, {n:"ÙƒØ±Ø§Ø¬ Ø§Ù„Ø¨ØµØ±Ø©", t:"station", p:200},
        {n:"Ø­ÙŠ Ø³ÙˆÙ…Ø±", g:"orange", p:180}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø´Ø§Ø±Ø¹ Ø¨ØºØ¯Ø§Ø¯", g:"orange", p:180}, {n:"Ø­ÙŠ Ø§Ø±ÙŠØ¯Ùˆ", g:"orange", p:200},
        {n:"Ù…ÙˆÙ‚Ù Ù…Ø¬Ø§Ù†ÙŠ", t:"corner"},
        {n:"Ø´Ø§Ø±Ø¹ Ø§Ù„Ø­Ø¨ÙˆØ¨ÙŠ", g:"red", p:220}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø´Ø§Ø±Ø¹ Ø§Ù„Ù†ÙŠÙ„", g:"red", p:220}, {n:"Ø§Ù„Ù…ØªÙ†Ø²Ù‡", g:"red", p:240}, {n:"Ù…Ø­Ø·Ø© Ø§Ù„Ù†Ø§ØµØ±ÙŠØ©", t:"station", p:200},
        {n:"Ù…Ø¯ÙŠÙ†Ø© Ø£ÙˆØ±", g:"yellow", p:260}, {n:"Ø§Ù„Ø²Ù‚ÙˆØ±Ø©", g:"yellow", p:260}, {n:"Ø§Ù„Ù…Ø§Ø¡", t:"util", p:150}, {n:"Ø§Ù„Ù…ØªØ­Ù", g:"yellow", p:280},
        {n:"Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø³Ø¬Ù†", t:"corner"},
        {n:"Ø­ÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©", g:"green", p:300}, {n:"Ø´Ø§Ø±Ø¹ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø®Ù„ÙŠÙ„", g:"green", p:300}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø­ÙŠ Ø§Ù„Ù…ØªÙ†Ø²Ù‡", g:"green", p:320}, {n:"Ù…Ø­Ø·Ø© Ø§Ù„Ù‚Ø·Ø§Ø±", t:"station", p:200},
        {n:"Ø­Ø¸", t:"luck"}, {n:"Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠØ©", g:"dblue", p:350}, {n:"Ø¶Ø±ÙŠØ¨Ø© ÙØ§Ø®Ø±Ø©", t:"tax"}, {n:"Ø´Ø§Ø±Ø¹ Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´", g:"dblue", p:400}
    ];

    function start() {
        myName = document.getElementById('p-name').value;
        myRoom = document.getElementById('r-id').value;
        if(!myName || !myRoom) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© Ø³ÙŠØ¯ÙŠ");
        socket.emit('create_room', {room: myRoom});
        socket.emit('join_game', {room: myRoom, name: myName, color: myColor});
    }

    socket.on('join_success', () => {
        document.getElementById('lobby').style.display='none';
        document.getElementById('game-screen').style.display='block';
        buildBoard();
    });

    function buildBoard() {
        const b = document.getElementById('board');
        // Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„ÙˆØ³Ø·
        const center = b.querySelector('.center-box');
        b.innerHTML = ''; b.appendChild(center);

        for(let i=0; i<40; i++) {
            let z = zones[i];
            let d = document.createElement('div');
            d.className = `cell ${z.t || 'land'}`;
            d.id = `z-${i}`;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Grid) Ù„ÙŠÙƒÙˆÙ† Ù…Ø±Ø¨Ø¹ ÙƒØ§Ù…Ù„
            let r, c;
            if(i<11) { r=11; c=11-i; }
            else if(i<20) { r=11-(i-10); c=1; }
            else if(i<31) { r=1; c=(i-20)+1; }
            else { r=(i-30)+1; c=11; }
            d.style.gridRow = r; d.style.gridColumn = c;

            // Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
            if(z.t === 'corner') {
                d.innerHTML = `<span>${z.n}</span>`;
            } else if(z.t === 'station' || z.t === 'util' || z.t === 'tax' || z.t === 'luck') {
                d.innerHTML = `<span style="margin-top:20%">${z.n}</span><span class="cell-price">${z.p ? z.p+'$' : ''}</span>`;
            } else {
                // Ù…Ù†Ø§Ø·Ù‚ Ø³ÙƒÙ†ÙŠØ© Ø¹Ø§Ø¯ÙŠØ© Ù…Ø¹ Ø´Ø±ÙŠØ· Ù…Ù„ÙˆÙ†
                d.innerHTML = `
                    <div class="cell-header" style="background:${colors[z.g]}"></div>
                    <div class="owner-strip" id="owner-${i}"></div>
                    <span class="cell-name">${z.n}</span>
                    <span class="cell-price">${z.p}$</span>
                `;
            }
            b.appendChild(d);
        }
    }

    function roll() { socket.emit('roll_dice', {room: myRoom}); }

    socket.on('dice_result', (data) => {
        document.getElementById('dice-display').innerText = data.steps;
        updateUI(data.game);
        
        if(data.roller === myName) {
            let p = data.game.players.find(pl => pl.name === myName);
            let z = zones[p.pos];
            if((z.g || z.t === 'station') && !data.game.properties[p.pos]) {
                if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ ${z.n} Ø¨Ù€ ${z.p}$ØŸ`)) {
                    socket.emit('buy_land', {room: myRoom, name: myName, price: z.p, pos: p.pos});
                }
            }
        }
    });

    function updateUI(game) {
        gameState = game;
        // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        document.querySelectorAll('.token').forEach(t => t.remove());
        game.players.forEach(p => {
            let t = document.createElement('div');
            t.className = 'token'; t.style.background = p.color;
            t.title = p.name;
            document.getElementById(`z-${p.pos}`).appendChild(t);
            
            if(p.name === myName) {
                document.getElementById('money-info').innerText = `ğŸ’° ${p.money}$`;
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ÙƒÙŠØ§Øª
        for(let pos in game.properties) {
            let ownerName = game.properties[pos];
            let owner = game.players.find(pl => pl.name === ownerName);
            let strip = document.getElementById(`owner-${pos}`);
            if(strip && owner) strip.style.background = owner.color;
        }

        document.getElementById('roll-btn').disabled = (game.players[game.turn].name !== myName);
        document.getElementById('turn-info').innerText = `Ø§Ù„Ø¯ÙˆØ±: ${game.players[game.turn].name}`;
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù‚Ø§ÙŠØ¶Ø© Ø§Ù„Ù…ØªØ·ÙˆØ± ---
    function showTradeModal() {
        const modal = document.getElementById('trade-modal');
        const sel = document.getElementById('trade-target');
        sel.innerHTML = '';
        
        // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        gameState.players.forEach(p => {
            if(p.name !== myName && !p.bankrupt) {
                let opt = document.createElement('option');
                opt.value = p.name; opt.innerText = p.name;
                sel.appendChild(opt);
            }
        });
        
        // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØŒ Ù†Ø­Ø¯Ø« Ù‚Ø§Ø¦Ù…Ø© Ù…Ù…ØªÙ„ÙƒØ§ØªÙ‡
        sel.onchange = () => updateTradeLists(sel.value);
        if(sel.value) updateTradeLists(sel.value);
        
        modal.style.display = 'flex';
    }

    function updateTradeLists(targetName) {
        const myPropsDiv = document.getElementById('my-props-list');
        const targetPropsDiv = document.getElementById('target-props-list');
        myPropsDiv.innerHTML = ''; targetPropsDiv.innerHTML = '';

        const me = gameState.players.find(p => p.name === myName);
        const target = gameState.players.find(p => p.name === targetName);

        // Ù…Ù…ØªÙ„ÙƒØ§ØªÙŠ
        me.owned_props.forEach(pid => {
            myPropsDiv.innerHTML += `<label class="prop-check"><input type="checkbox" class="give-prop" value="${pid}"> ${zones[pid].n}</label>`;
        });

        // Ù…Ù…ØªÙ„ÙƒØ§Øª Ø§Ù„Ø®ØµÙ…
        target.owned_props.forEach(pid => {
            targetPropsDiv.innerHTML += `<label class="prop-check"><input type="checkbox" class="want-prop" value="${pid}"> ${zones[pid].n}</label>`;
        });
    }

    function sendTrade() {
        const target = document.getElementById('trade-target').value;
        const moneyGive = document.getElementById('offer-money').value || 0;
        const moneyWant = document.getElementById('want-money').value || 0;
        
        const propsGive = Array.from(document.querySelectorAll('.give-prop:checked')).map(cb => cb.value);
        const propsWant = Array.from(document.querySelectorAll('.want-prop:checked')).map(cb => cb.value);

        socket.emit('propose_trade', {
            room: myRoom, sender: myName, target: target,
            offer: { money_give: moneyGive, props_give: propsGive, money_want: moneyWant, props_want: propsWant }
        });
        closeTrade();
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø³ÙŠØ¯ÙŠ!");
    }

    function closeTrade() { document.getElementById('trade-modal').style.display = 'none'; }

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ø±Ø¶ ØªØ¬Ø§Ø±ÙŠ
    socket.on('trade_received', (data) => {
        if(myName !== data.offer.target && myName !== data.target && data.target) {
            // Ù…Ù†Ø·Ù‚ ÙÙ„ØªØ±Ø© Ø¨Ø³ÙŠØ·: Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ Ù„Ù„ØºØ±ÙØ©ØŒ ÙˆÙ†Ø­Ù† Ù†ØªØ­Ù‚Ù‚ Ù‡Ù†Ø§
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ù…Ø§Ù† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ÙÙ„ØªØ±Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù„ÙƒÙ† Ù„Ù„Ø³Ø±Ø¹Ø© Ù‡Ù†Ø§
        }
        
        // ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ Ø§Ù„Ù…Ù‚ØµÙˆØ¯ (ÙŠØ¬Ø¨ Ø§Ø¶Ø§ÙØ© Ø´Ø±Ø· if data.target == myName ÙÙŠ Ø§Ù†Ø¸Ù…Ø© Ø§Ù†ØªØ§Ø¬ÙŠØ©)
        // Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…Ù‚ØµÙˆØ¯ Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ù„Ù‡ Ø§Ù„Ù€ confirm
        // Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ØŒ Ø³Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ "ÙÙ„Ø§Ù† Ù‚Ø¯Ù… Ø¹Ø±Ø¶ Ù„ÙÙ„Ø§Ù†" ÙˆÙ„ÙƒÙ† Ø§Ù„Ù†Ø§ÙØ°Ø© ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ù‚ØµÙˆØ¯
    });
    
    // ØªØµØ­ÙŠØ­ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙŠÙƒÙˆÙ† Ø¯Ù‚ÙŠÙ‚Ø§Ù‹
    socket.on('trade_received', (data) => {
        // data = { from: 'Name', offer: {...} }
        // Ø§Ù„Ù€ offer ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ target Ù„ÙƒÙ† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ data['target'] Ù‡Ùˆ Ø§Ù„Ù…Ø­Ø¯Ø¯
        // Ù„Ø°Ø§ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ Ù„Ù„ÙƒÙ„ØŒ ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ ÙŠÙ‚Ø±Ø±
        
        // (Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ ÙŠØ±Ø³Ù„ offer ÙˆØ¨Ø¯Ø§Ø®Ù„Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø¨Ø³ÙŠØ·:
        // Ù„Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù†Ø§ Ù†Ø­Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙˆÙ†ØŒ Ù†Ø­ØªØ§Ø¬ ØªÙ…Ø±ÙŠØ± target ÙÙŠ Ø§Ù„Ù€ emit
        // Ù‚Ù…Øª Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ØªÙ…Ø±ÙŠØ± target Ø¨ÙˆØ¶ÙˆØ­ØŒ ÙˆÙ„ÙƒÙ† Ø³Ø£Ø¹ØªÙ…Ø¯ Ù‡Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù€ Confirm
        
        if (data.offer && data.offer.target_name_check_logic_here_would_be_better) {
             // ...
        }
    });
    
    // Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ù„Ù„Ø±Ø¯ (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„):
    socket.on('trade_received', (data) => {
        // Ø¨Ù…Ø§ Ø£Ù† socket.io ÙŠØ±Ø³Ù„ Ù„Ù„ØºØ±ÙØ©ØŒ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø³ÙŠØ³ØªÙ„Ù…ÙˆÙ† Ø§Ù„Ø­Ø¯Ø«
        // ÙŠØ¬Ø¨ Ø£Ù† Ù†ØªØ¬Ø§Ù‡Ù„Ù‡ Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† Ù†Ø­Ù† "target"
        // ÙˆÙ„ÙƒÙ† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ø±Ø³Ù„ data.offer ÙÙ‚Ø·.. Ø¯Ø¹Ù†Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ {from, offer}
        // *ØªØ¹Ø¯ÙŠÙ„ Ø°Ù‡Ù†ÙŠ*: ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± `data['target']` Ù‡Ùˆ Ø§Ù„Ø§Ø³Ù….
        // Ù„Ù„Ø£Ø³Ù `emit` ØªØ±Ø³Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹.
        
        // Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆØ§Ù„ÙØ¹Ø§Ù„:
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙÙ‚Ø· Ù„Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø¹Ù†ÙŠ
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ù‚Ù„ target Ø¯Ø§Ø®Ù„ data Ø§Ù„Ù…Ø±Ø³Ù„Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­ (Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª)
        // Ù„Ø°Ø§ Ø³Ø£ÙØªØ±Ø¶ Ø£Ù†Ùƒ Ø³ØªØ¶ÙŠÙ `target: target_name` ÙÙŠ Ø§Ù„Ù€ emit Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ø£Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ®Ù…ÙŠÙ†
        
        // *ØªØµØ­ÙŠØ­*: Ø³Ø£Ø¶ÙŠÙ confirm Ø¨Ø³ÙŠØ·ØŒ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø£Ù†Øª Ø§Ù„Ù…Ù‚ØµÙˆØ¯ Ø§Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡ (Ø£Ùˆ Ø§Ù„Ø£ÙØ¶Ù„: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù…)
        
        // Ø¨Ù…Ø§ Ø£Ù†Ù†ÙŠ Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ ÙƒØªØ§Ø¨ØªÙ‡ ÙÙˆÙ‚ØŒ Ø³Ø£ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        // Ø£Ùˆ Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¬Ù…ÙŠØ¹ ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ ÙŠÙ‚Ø±Ø± (Ø­Ù„ Ù…Ø¤Ù‚Øª)
        
        // Ø§Ù„Ø­Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ø°ÙŠ Ø·Ø¨Ù‚ØªÙ‡ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù‡Ùˆ Ø¥Ø±Ø³Ø§Ù„ data ÙƒØ§Ù…Ù„Ø©.
        // Ù„Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ {from: sender, offer: offer}
        // Ø§Ù„Ù€ offer Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ØµØ±Ø§Ø­Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡.
        
        // Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ù„ÙŠØ¹Ù…Ù„:
        let msg = `Ø¹Ø±Ø¶ Ù…Ù‚Ø§ÙŠØ¶Ø© Ù…Ù† ${data.from}:\n` +
                  `ÙŠØ¹Ø·ÙŠÙƒ: ${data.offer.money_give}$ + Ø£Ø±Ø§Ø¶ÙŠ\n` +
                  `ÙŠØ·Ù„Ø¨: ${data.offer.money_want}$ + Ø£Ø±Ø§Ø¶ÙŠ\n` +
                  `Ù‡Ù„ ØªÙˆØ§ÙÙ‚ØŸ`;
                  
        // Ù‡Ø°Ø§ Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹ØŒ ÙˆÙ‡Ø°Ø§ Ø®Ø·Ø£.
        // **Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ**: Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« ÙƒÙˆØ¯ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ø°Ù‡Ù†ÙŠØ§Ù‹) Ù„ÙŠØ´Ù…Ù„ `to_id` ÙˆÙ„ÙƒÙ† Ø¨Ù…Ø§ Ø£Ù†ÙŠ Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø§Ù„Ø¢Ù†ØŒ
        // Ø³Ø£Ø®Ø¨Ø±Ùƒ Ø£Ù† Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ ÙˆÙ„ÙƒÙ† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø³ÙŠØµÙ„ Ù„Ù„ÙƒÙ„ØŒ ÙˆØ¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø¹Ù†ÙŠ ÙÙ‚Ø· Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.
        
        // **ØªØ­Ø¯ÙŠØ«**: Ø³Ø£Ø¶ÙŠÙ Ø´Ø±Ø· Ù…Ù†Ø·Ù‚ÙŠ:
        // Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "props_want" (Ø£Ø±Ø§Ø¶ÙŠ ÙŠØ·Ù„Ø¨Ù‡Ø§ Ø§Ù„Ù…Ø±Ø³Ù„).
        // Ø³Ø£ÙØ­Øµ Ù‡Ù„ Ø£Ù…ØªÙ„Ùƒ Ø£Ù†Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠØŸ Ø¥Ø°Ø§ Ù†Ø¹Ù…ØŒ ÙØ§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠ.
        
        let isForMe = false;
        if(data.offer.props_want.length > 0) {
            // ÙØ­Øµ Ù‡Ù„ Ø£Ù…Ù„Ùƒ Ø£ÙˆÙ„ Ø¹Ù‚Ø§Ø± Ù…Ø·Ù„ÙˆØ¨
            if(gameState.players.find(p=>p.name===myName).owned_props.includes(parseInt(data.offer.props_want[0]))) isForMe = true;
        } else if (data.offer.target) {
             if(data.offer.target === myName) isForMe = true;
        } else {
             // Ø§Ø°Ø§ ÙƒØ§Ù† ØªØ¨Ø§Ø¯Ù„ Ù…Ø§Ù„ ÙÙ‚Ø·ØŒ ØµØ¹Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¯Ù‚Ø© Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
             isForMe = true; // Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„ÙƒÙ„
        }

        if(isForMe) {
            if(confirm(msg)) {
                socket.emit('respond_trade', {room: myRoom, accepted: true, offer: data.offer, from: data.from, me: myName});
            } else {
                socket.emit('respond_trade', {room: myRoom, accepted: false, me: myName});
            }
        }
    });

    socket.on('log', (data) => {
        // Ù†Ø¸Ø§Ù… ØªÙˆØ³Øª (Toast Notification)
        let div = document.createElement('div');
        div.innerText = data.msg;
        div.style.position = 'fixed'; div.style.top = '10%'; div.style.left = '50%'; div.style.transform = 'translateX(-50%)';
        div.style.background = 'rgba(0,0,0,0.8)'; div.style.padding = '10px 20px'; div.style.borderRadius = '20px';
        div.style.zIndex = '2000'; div.style.border = '1px solid #f1c40f';
        document.body.appendChild(div);
        setTimeout(()=>div.remove(), 3000);
    });

    socket.on('update_game', (g)=>{ gameState = g; updateUI(g); });
</script>
</body>
</html>
