<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ© - Voice Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { background: #1a1a1a; color: #fff; font-family: 'Cairo', sans-serif; margin: 0; overflow: hidden; }
        
        #game-ui { display: flex; flex-direction: column; height: 100vh; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        #top-bar { padding: 10px; background: #2d3436; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .mic-btn { background: #e74c3c; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; color: white; transition: 0.3s; }
        .mic-active { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        /* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        #board-container { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #2c3e50; overflow: hidden; }
        .board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); width: 98vmin; height: 98vmin; background: #dfe6e9; border: 4px solid #000; font-size: 0.8em; }
        
        .cell { position: relative; border: 1px solid #b2bec3; display: flex; flex-direction: column; align-items: center; text-align: center; color: #000; font-weight: bold; font-size: 10px; }
        .color-bar { width: 100%; height: 20%; background: #bdc3c7; }
        .house-container { position: absolute; top: 2px; display: flex; gap: 1px; }
        .house-icon { width: 6px; height: 6px; background: #27ae60; border: 1px solid #fff; }
        .hotel-icon { width: 10px; height: 10px; background: #c0392b; border: 1px solid #fff; }

        .center { grid-column: 2 / 11; grid-row: 2 / 11; background: #1a1a1a; display: flex; flex-direction: column; justify-content: center; align-items: center; color: gold; }
        
        /* Ø§Ù„ØªØ­ÙƒÙ… */
        #controls { padding: 15px; background: #2d3436; display: flex; gap: 10px; justify-content: center; border-top: 2px solid gold; }
        button { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-family: inherit; }
        .btn-roll { background: gold; color: #000; }
        .btn-buy { background: #3498db; color: white; display: none; }
        .btn-build { background: #e67e22; color: white; display: none; }

        .token { width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; position: absolute; z-index: 10; transition: all 0.5s ease; box-shadow: 0 0 5px black; bottom: 5px;}
    </style>
</head>
<body>

<div id="login" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1a1a1a; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
    <h1 style="color:gold; text-shadow:0 0 10px orange;">ğŸ‘‘ Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
    <input id="name" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…" style="padding:10px; margin:5px; text-align:center;">
    <input id="room" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" style="padding:10px; margin:5px; text-align:center;">
    <button onclick="startGame()" class="btn-roll">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="game-ui" style="display:none;">
    <div id="top-bar">
        <div id="status">Ø§Ù„Ø±ØµÙŠØ¯: 1500$</div>
        <button id="mic-btn" class="mic-btn" onclick="toggleMic()">ğŸ¤</button>
    </div>

    <div id="board-container">
        <div class="board" id="board">
            <div class="center">
                <h1 style="margin:0;">DHI QAR</h1>
                <div id="msg-box" style="color:white; margin-top:10px; font-size:12px;"></div>
            </div>
        </div>
    </div>

    <div id="controls">
        <button id="roll-btn" class="btn-roll" onclick="rollDice()">ğŸ² Ø§Ø±Ù…ÙŠ Ø§Ù„Ø²Ø§Ø±</button>
        <button id="buy-btn" class="btn-buy" onclick="buyProp()">ğŸ  Ø´Ø±Ø§Ø¡</button>
        <button id="build-btn" class="btn-build" onclick="buildHouse()">ğŸ—ï¸ ØªØ·ÙˆÙŠØ±</button>
    </div>
</div>

<audio id="s-roll" src="https://www.soundjay.com/misc/sounds/dice-throw-1.mp3"></audio>
<audio id="s-buy" src="https://www.soundjay.com/button/sounds/button-3.mp3"></audio>
<audio id="s-build" src="https://www.soundjay.com/mechanical/sounds/clank-car-crash-collision-1.mp3"></audio>

<script>
    const socket = io();
    let myName, myRoom, myMoney = 1500;
    let localStream, peerConnection;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let peers = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„ØµÙˆØª

    // ØªØ¹Ø±ÙŠÙ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±)
    const zoneNames = ["Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", "Ø³ÙˆÙ‚ Ø§Ù„Ø´ÙŠÙˆØ®", "Ø­Ø¸", "Ø§Ù„Ø¹ÙƒÙŠÙƒØ©", "Ø¶Ø±ÙŠØ¨Ø©", "ÙƒØ±Ø§Ø¬ Ø¨ØºØ¯Ø§Ø¯", "ÙƒØ±Ù…Ø©", "ÙØ±ØµØ©", "Ø§Ù„Ø·Ø§Ø±", "Ø§Ù„ÙÙ‡ÙˆØ¯", "Ø³Ø¬Ù†", "Ø§Ù„ÙØ¯Ø§Ø¡", "ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡", "Ø§Ù„Ø´Ù…ÙˆØ®", "ÙƒØ±Ø§Ø¬ Ø§Ù„Ø¨ØµØ±Ø©", "Ø³ÙˆÙ…Ø±", "Ø­Ø¸", "Ø´ Ø¨ØºØ¯Ø§Ø¯", "Ø§Ø±ÙŠØ¯Ùˆ", "Ù…ÙˆÙ‚Ù", "Ø§Ù„Ø­Ø¨ÙˆØ¨ÙŠ", "ÙØ±ØµØ©", "Ø´ Ø§Ù„Ù†ÙŠÙ„", "Ø§Ù„Ù…ØªÙ†Ø²Ù‡", "Ù…Ø­Ø·Ø©", "Ø£ÙˆØ±", "Ø§Ù„Ø²Ù‚ÙˆØ±Ø©", "Ù…Ø§Ø¡", "Ø§Ù„Ù…ØªØ­Ù", "Ù„Ù„Ø³Ø¬Ù†", "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø­Ø¸", "Ø§Ù„Ù…ØªÙ†Ø²Ù‡", "Ù‚Ø·Ø§Ø±", "ÙØ±ØµØ©", "Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠØ©", "Ø¶Ø±ÙŠØ¨Ø©", "Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´"];

    function startGame() {
        myName = document.getElementById('name').value;
        myRoom = document.getElementById('room').value;
        if(!myName || !myRoom) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ¯ÙŠ");
        
        socket.emit('create_room', {room: myRoom});
        socket.emit('join_game', {room: myRoom, name: myName, color: '#'+Math.floor(Math.random()*16777215).toString(16)});
    }

    socket.on('join_success', () => {
        document.getElementById('login').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        renderBoard();
        setupVoiceChat(); // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØª
    });

    function renderBoard() {
        const b = document.getElementById('board');
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„ÙƒÙ† Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„Ù„ÙˆÙ†)
        for(let i=0; i<40; i++) {
            if(document.getElementById('cell-'+i)) continue;
            let d = document.createElement('div');
            d.className = 'cell'; d.id = 'cell-'+i;
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Grid
            let r, c;
            if(i<11) { r=11; c=11-i; }
            else if(i<20) { r=11-(i-10); c=1; }
            else if(i<31) { r=1; c=(i-20)+1; }
            else { r=(i-30)+1; c=11; }
            if(i===0) {r=11;c=11;} // ØªØµØ­ÙŠØ­ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            
            d.style.gridRow = r; d.style.gridColumn = c;
            d.innerHTML = `
                <div class="color-bar" id="bar-${i}"></div>
                <div class="house-container" id="house-${i}"></div>
                <span>${zoneNames[i]}</span>
                <span id="price-${i}" style="font-size:8px; color:gray;"></span>
            `;
            b.appendChild(d);
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù„Ø¹Ø¨ ---
    function rollDice() { socket.emit('roll_dice', {room: myRoom}); }
    
    socket.on('dice_result', (data) => {
        document.getElementById('s-roll').play();
        document.getElementById('msg-box').innerText = `${data.roller} Ø±Ù…Ù‰ ${data.steps}. ${data.msg}`;
        moveToken(data.roller, data.game);
        
        // Ù…Ù†Ø·Ù‚ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        const me = data.game.players.find(p => p.name === myName);
        if(data.roller === myName) {
            const pos = me.pos;
            const prop = data.game.properties[pos];
            // Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
            if(!prop && ![0,2,4,7,10,12,17,20,22,28,30,33,36,38].includes(pos)) {
                document.getElementById('buy-btn').style.display = 'block';
                document.getElementById('buy-btn').onclick = () => {
                    socket.emit('buy_prop', {room: myRoom, name: myName, pos: pos});
                    document.getElementById('buy-btn').style.display = 'none';
                };
            } else {
                document.getElementById('buy-btn').style.display = 'none';
            }
            
            // Ø²Ø± Ø§Ù„ØªØ·ÙˆÙŠØ± (Ø§Ù„Ø¨Ù†Ø§Ø¡)
            // (Ø¨Ø³ÙŠØ·: ÙŠØ¸Ù‡Ø± Ø¥Ø°Ø§ ÙƒÙ†Øª ØªÙ…Ù„Ùƒ Ø§Ù„Ù…ÙƒØ§Ù†ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±)
            if(prop === myName) {
                document.getElementById('build-btn').style.display = 'block';
                document.getElementById('build-btn').onclick = () => {
                    socket.emit('build_house', {room: myRoom, name: myName, pos: pos});
                };
            } else {
                document.getElementById('build-btn').style.display = 'none';
            }
        }
    });

    socket.on('play_sound', (data) => {
        if(data.sound === 'buy') document.getElementById('s-buy').play();
        if(data.sound === 'build') document.getElementById('s-build').play();
    });

    socket.on('update_game', (game) => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
        const me = game.players.find(p => p.name === myName);
        if(me) document.getElementById('status').innerText = `Ø§Ù„Ø±ØµÙŠØ¯: ${me.money}$`;

        // Ø±Ø³Ù… Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª
        game.players.forEach(p => {
            let t = document.getElementById('t-'+p.name);
            if(!t) {
                t = document.createElement('div');
                t.className = 'token'; t.id = 't-'+p.name;
                t.style.backgroundColor = p.color;
                document.body.appendChild(t); // Append to body to move absolutely over grid
            }
            // ØªØ­Ø±ÙŠÙƒ Ø¨Ø³ÙŠØ· (Ù†Ø­ØªØ§Ø¬ Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø®Ù„ÙŠØ©)
            const cell = document.getElementById('cell-'+p.pos);
            const rect = cell.getBoundingClientRect();
            t.style.left = (rect.left + 10) + 'px';
            t.style.top = (rect.top + 10) + 'px';
        });

        // ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙˆØ§Ù„Ù…Ù†Ø§Ø²Ù„
        for(const [pos, ownerName] of Object.entries(game.properties)) {
            const owner = game.players.find(p => p.name === ownerName);
            if(owner) document.getElementById('bar-'+pos).style.backgroundColor = owner.color;
        }
        for(const [pos, count] of Object.entries(game.houses)) {
            const hCont = document.getElementById('house-'+pos);
            hCont.innerHTML = '';
            for(let k=0; k<count; k++) {
                let h = document.createElement('div');
                h.className = (count === 5) ? 'hotel-icon' : 'house-icon';
                hCont.appendChild(h);
            }
        }
    });

    function moveToken(name, game) {
        // ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙÙŠ update_game Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù‡Ù†Ø§
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØµÙˆØªÙŠØ© (WebRTC Simple) ---
    async function setupVoiceChat() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        } catch(e) { console.log("Ø§Ù„Ù…Ø§ÙŠÙƒ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­"); }
    }

    let isMicOn = false;
    function toggleMic() {
        isMicOn = !isMicOn;
        document.getElementById('mic-btn').className = isMicOn ? "mic-btn mic-active" : "mic-btn";
        if(localStream) {
            localStream.getAudioTracks()[0].enabled = isMicOn;
            if(isMicOn) joinVoiceRoom();
        }
    }

    function joinVoiceRoom() {
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        socket.emit('voice_signal', { type: 'join', room: myRoom, sender: myName });
    }

    socket.on('voice_signal', async (data) => {
        if(data.sender === myName) return;
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Peer Connection Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø§Ø±Ø©
        if(!peers[data.sender]) {
            const pc = new RTCPeerConnection(config);
            peers[data.sender] = pc;
            
            pc.onicecandidate = (event) => {
                if(event.candidate) {
                    socket.emit('voice_signal', { type: 'candidate', candidate: event.candidate, target: data.sender, room: myRoom, sender: myName });
                }
            };

            pc.ontrack = (event) => {
                const audio = new Audio();
                audio.srcObject = event.streams[0];
                audio.play();
            };
            
            if(localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            if(data.type === 'join') {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('voice_signal', { type: 'offer', offer: offer, target: data.sender, room: myRoom, sender: myName });
            }
        }

        const pc = peers[data.sender];
        if(data.type === 'offer') {
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('voice_signal', { type: 'answer', answer: answer, target: data.sender, room: myRoom, sender: myName });
        } else if(data.type === 'answer') {
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if(data.type === 'candidate') {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    });

</script>
</body>
</html>
