<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ© - Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { background: #121212; color: white; font-family: 'Cairo', sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª */
        .board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); width: 98vw; height: 98vw; background: #2c3e50; border: 2px solid #f1c40f; margin: 2px auto; box-shadow: 0 0 20px rgba(241, 196, 15, 0.2); }
        .cell { background: #ecf0f1; border: 0.5px solid #95a5a6; color: #2c3e50; font-size: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; font-weight: bold; text-align: center; }
        .station { background: #bdc3c7; color: #2c3e50; }
        .corner { background: #f39c12; color: white; }
        
        /* Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø§Ù„Ù…Ø¶Ù…ÙˆÙ†Ø© */
        .board-center { 
            grid-column: 2 / 11; grid-row: 2 / 11; 
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Dhi_Qar_in_Iraq.svg/1024px-Dhi_Qar_in_Iraq.svg.png') center/50% no-repeat;
            background-color: #27ae60;
            display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.95;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        
        /* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø²Ù„ ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .owner-bar { position: absolute; top: 0; width: 100%; height: 3px; }
        .houses-bar { position: absolute; bottom: 1px; display: flex; gap: 1px; }
        .house-icon { width: 3px; height: 3px; background: #c0392b; border-radius: 50%; box-shadow: 0 0 2px black; }
        .token { width: 10px; height: 10px; border-radius: 50%; border: 2px solid #fff; position: absolute; z-index: 99; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 3px 6px rgba(0,0,0,0.4); }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #ui-layer { position: fixed; bottom: 0; width: 100%; height: 140px; background: linear-gradient(0deg, #1a1a1a 0%, rgba(26,26,26,0) 100%); pointer-events: none; }
        #controls { pointer-events: auto; position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: space-around; align-items: flex-end; padding: 0 10px; box-sizing: border-box; }
        
        .btn { background: #e67e22; color: white; border: none; padding: 10px 20px; border-radius: 12px; font-weight: bold; font-family: 'Cairo'; box-shadow: 0 4px #d35400; transition: 0.1s; }
        .btn:active { transform: translateY(3px); box-shadow: 0 1px #d35400; }
        .btn-trade { background: #3498db; box-shadow: 0 4px #2980b9; }
        .btn-build { background: #27ae60; box-shadow: 0 4px #219150; display: none; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        #player-list { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; border: 1px solid #f1c40f; z-index: 200; width: 120px; }
        .p-item { font-size: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; border-bottom: 1px solid #555; padding-bottom: 2px; }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª */
        .dice-box { font-size: 30px; background: white; color: #333; padding: 5px 15px; border-radius: 10px; border: 3px solid #f1c40f; }
        .shake { animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: rotate(0); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } }
    </style>
</head>
<body>

<div id="lobby" style="text-align: center; margin-top: 30vh;">
    <h1 style="color: #f1c40f; text-shadow: 0 0 10px #e67e22;">ğŸ‘‘ Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
    <input id="u-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ùƒ" style="padding: 12px; border-radius: 8px; border: none; text-align: center;">
    <input id="r-name" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" style="padding: 12px; border-radius: 8px; border: none; text-align: center;">
    <br><br>
    <button class="btn" onclick="joinGame()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù…Ù„ÙƒØ©</button>
</div>

<div id="game" class="hidden">
    <div id="player-list"></div> <div class="board" id="board">
        <div class="board-center">
            <h2 style="color: white; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px;">Ø°ÙŠ Ù‚Ø§Ø±</h2>
        </div>
    </div>

    <div id="ui-layer">
        <div id="controls">
            <div style="text-align: right;">
                <div id="my-money" style="font-size: 20px; color: #2ecc71; font-weight: bold;">0$</div>
                <div id="status-txt" style="font-size: 10px; color: #bdc3c7;">Ø§Ù†ØªØ¸Ø±...</div>
            </div>
            
            <div id="dice-visual" class="dice-box">ğŸ²</div>

            <div style="display: flex; gap: 5px; flex-direction: column;">
                <button id="roll-btn" class="btn" onclick="rollDice()">Ø§Ø±Ù…ÙŠ Ø§Ù„Ø²Ø§Ø±</button>
                <button id="trade-btn" class="btn btn-trade" onclick="openTrade()">ğŸ¤ Ù…Ù‚Ø§ÙŠØ¶Ø©</button>
                <button id="build-btn" class="btn btn-build" onclick="upgradeProp()">ğŸ—ï¸ ØªØ·ÙˆÙŠØ±</button>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let myName, myRoom, myColor = '#'+Math.floor(Math.random()*16777215).toString(16);
    let gameState = null;
    let playerPositions = {};

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ (40 Ù…Ù†Ø·Ù‚Ø© ÙƒØ§Ù…Ù„Ø©)
    const zones = new Array(40).fill(null).map((_, i) => {
        if(i===0) return {n:"Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", t:"start", p:0, c:"corner"};
        if(i===10) return {n:"Ø§Ù„Ø³Ø¬Ù†", t:"jail", p:0, c:"corner"};
        if(i===20) return {n:"Ù…ÙˆÙ‚Ù Ù…Ø¬Ø§Ù†ÙŠ", t:"park", p:0, c:"corner"};
        if(i===30) return {n:"Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø³Ø¬Ù†", t:"gotojail", p:0, c:"corner"};
        if([5,15,25,35].includes(i)) return {n:"Ù…Ø­Ø·Ø© Ù‚Ø·Ø§Ø±", t:"station", p:200, c:"station"};
        if([2,7,17,22,33,36].includes(i)) return {n:"ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¸", t:"luck", p:0, c:"luck"};
        if([12,28].includes(i)) return {n:"Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡", t:"util", p:150, c:"luck"};
        return {n:`Ù…Ù†Ø·Ù‚Ø© ${i}`, t:"land", p:100 + (i*5), c:"land"};
    });
    // ØªØ³Ù…ÙŠØ© Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©
    const cityNames = {1:"Ø§Ù„Ø«ÙˆØ±Ø©", 3:"Ø§Ù„Ø´Ù…ÙˆØ®", 6:"Ø³ÙˆÙ‚ Ø§Ù„Ø´ÙŠÙˆØ®", 9:"Ø§Ù„ÙÙ‡ÙˆØ¯", 39:"Ø§Ù„Ù†Ø§ØµØ±ÙŠØ©", 37:"Ø§Ù„Ø´Ø·Ø±Ø©"};
    for(let k in cityNames) zones[k].n = cityNames[k];

    function joinGame() {
        myName = document.getElementById('u-name').value;
        myRoom = document.getElementById('r-name').value;
        if(!myName) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨ Ø³ÙŠØ¯ÙŠ!");
        socket.emit('create_room', {room: myRoom});
        socket.emit('join_game', {room: myRoom, name: myName, color: myColor});
    }

    socket.on('join_success', () => {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game').classList.remove('hidden');
        renderBoard();
    });

    function renderBoard() {
        const b = document.getElementById('board');
        const center = b.querySelector('.board-center');
        b.innerHTML = ''; b.appendChild(center);
        
        for(let i=0; i<40; i++) {
            let r, c;
            if(i<11) { r=11; c=11-i; }
            else if(i<20) { r=11-(i-10); c=1; }
            else if(i<31) { r=1; c=(i-20)+1; }
            else { r=(i-30)+1; c=11; }

            let d = document.createElement('div');
            d.className = `cell ${zones[i].c}`;
            d.style.gridRow = r; d.style.gridColumn = c;
            d.id = `zone-${i}`;
            
            let content = `
                <div class="owner-bar" id="bar-${i}"></div>
                <span>${zones[i].t=='station'?'ğŸš‚':zones[i].t=='luck'?'â“':'ğŸ '}</span>
                <div style="font-size:5px">${zones[i].n}</div>
                <div style="font-size:4px; color:#27ae60">${zones[i].p>0?zones[i].p+'$':''}</div>
                <div class="houses-bar" id="house-${i}"></div>
            `;
            d.innerHTML = content;
            b.appendChild(d);
        }
    }

    function rollDice() {
        document.getElementById('dice-visual').classList.add('shake');
        socket.emit('roll_dice', {room: myRoom});
    }

    function openTrade() {
        let target = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ Ù„Ù‡:");
        let amount = prompt("ÙƒÙ… Ø§Ù„Ù…Ø¨Ù„ØºØŸ");
        if(target && amount) socket.emit('trade', {room: myRoom, sender: myName, receiver: target, amount: amount});
    }

    function upgradeProp() {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙŠ ÙŠÙ‚Ù Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨
        let p = gameState.players.find(pl => pl.name === myName);
        if(p) socket.emit('upgrade_land', {room: myRoom, name: myName, pos: p.pos});
    }

    socket.on('dice_result', async (data) => {
        document.getElementById('dice-visual').classList.remove('shake');
        document.getElementById('dice-visual').innerText = data.steps;
        
        const p = data.game.players.find(pl => pl.name === data.roller);
        let curr = playerPositions[p.name] || 0;
        
        // Ø­Ø±ÙƒØ© ØªØ¯Ø±ÙŠØ¬ÙŠØ©
        if(!p.is_bankrupt) {
            for(let i=0; i<data.steps; i++) {
                curr = (curr + 1) % 40;
                moveToken(p.name, curr, p.color);
                await new Promise(r => setTimeout(r, 200));
            }
        }
        playerPositions[p.name] = p.pos;
        if(p.name === myName) checkZone(p.pos, data.game);
    });

    function moveToken(name, pos, color) {
        let old = document.getElementById(`t-${name}`);
        if(old) old.remove();
        let t = document.createElement('div');
        t.className = 'token'; t.id = `t-${name}`;
        t.style.backgroundColor = color;
        document.getElementById(`zone-${pos}`).appendChild(t);
    }

    function checkZone(pos, game) {
        let zone = zones[pos];
        if((zone.t === 'land' || zone.t === 'station' || zone.t === 'util') && !game.properties[pos]) {
            if(confirm(`Ù‡Ù„ ØªØ´ØªØ±ÙŠ ${zone.n} Ø¨Ù€ ${zone.p}$ØŸ`)) {
                socket.emit('buy_land', {room: myRoom, name: myName, price: zone.p, pos: pos});
            }
        }
        
        // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ Ù‡Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        if(game.properties[pos] === myName && zone.t === 'land') {
            document.getElementById('build-btn').style.display = 'block';
        } else {
            document.getElementById('build-btn').style.display = 'none';
        }
    }

    socket.on('update_game', (game) => {
        gameState = game;
        let listHtml = '';
        
        game.players.forEach(p => {
            if(!p.is_bankrupt) {
                if(!playerPositions[p.name]) moveToken(p.name, p.pos, p.color);
                listHtml += `<div class="p-item" style="color:${p.color}"><span>${p.name}</span><span>${p.money}$</span></div>`;
                if(p.name === myName) document.getElementById('my-money').innerText = p.money + "$";
            }
        });
        document.getElementById('player-list').innerHTML = listHtml;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙˆØ§Ù„Ù…Ù†Ø§Ø²Ù„
        for(let pos in game.properties) {
            let owner = game.players.find(pl => pl.name === game.properties[pos]);
            if(owner) {
                document.getElementById(`bar-${pos}`).style.backgroundColor = owner.color;
                // Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø²Ù„
                let hCount = game.houses[pos] || 0;
                let hHtml = '';
                for(let i=0; i<hCount; i++) hHtml += '<div class="house-icon"></div>';
                document.getElementById(`house-${pos}`).innerHTML = hHtml;
            }
        }

        let turnPlayer = game.players[game.turn];
        document.getElementById('status-txt').innerText = `Ø§Ù„Ø¯ÙˆØ± Ø¹Ù†Ø¯: ${turnPlayer.name}`;
        document.getElementById('roll-btn').disabled = (turnPlayer.name !== myName);
    });

    socket.on('log', (data) => {
        let n = document.createElement('div');
        n.innerText = data.msg;
        n.style.position = 'fixed'; n.style.top = '50%'; n.style.left = '50%';
        n.style.transform = 'translate(-50%, -50%)'; n.style.background = 'rgba(0,0,0,0.8)';
        n.style.padding = '20px'; n.style.borderRadius = '10px'; n.style.zIndex = '999';
        document.body.appendChild(n);
        setTimeout(() => n.remove(), 2000);
    });
</script>
</body>
</html>
