<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÙˆÙ†ÙˆØ¨ÙˆÙ„ÙŠ Ø°ÙŠ Ù‚Ø§Ø± Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ù‡Ø§ØªÙ Ø³ÙŠØ¯ÙŠ */
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #game-screen { display: flex; flex-direction: column; height: 100%; }
        .board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); width: 98vw; height: 98vw; background: #27ae60; border: 4px solid #1e8449; margin: auto; position: relative; }
        .cell { background: white; border: 0.5px solid #ccc; color: #333; font-size: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .owner-tag { position: absolute; top: 0; width: 100%; height: 4px; }
        .token { width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid white; position: absolute; z-index: 10; transition: all 0.4s ease-in-out; }
        #controls { background: #1e272e; padding: 10px; display: flex; justify-content: space-around; align-items: center; border-top: 2px solid #e67e22; }
        .dice-btn { background: #e67e22; padding: 10px 20px; border-radius: 8px; font-weight: bold; border: none; color: white; }
    </style>
</head>
<body>

<div id="lobby" style="text-align: center; padding-top: 50px;">
    <h1>ğŸ›ï¸ Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
    <input id="p-name" placeholder="Ø§Ø³Ù…Ùƒ">
    <input id="r-id" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
    <button onclick="createRoom()">Ø¨Ø¯Ø¡</button>
</div>

<div id="game-screen" class="hidden">
    <div class="board" id="board"></div>
    <div id="controls">
        <div>
            <div id="money-info" style="color: #2ecc71;">ğŸ’° 2000$</div>
            <div id="turn-txt" style="font-size: 10px;">Ø§Ù†ØªØ¸Ø± Ø¯ÙˆØ±Ùƒ</div>
        </div>
        <div id="dice-val" style="font-size: 30px;">ğŸ²</div>
        <button id="roll-btn" class="dice-btn" onclick="roll()">Ø§Ø±Ù…ÙŠ Ø³ÙŠØ¯ÙŠ</button>
    </div>
</div>

<script>
    const socket = io();
    let myRoom, myName, myColor = '#' + Math.floor(Math.random()*16777215).toString(16);
    let playerPositions = {}; // Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´ÙŠ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©

    // 40 Ù…Ù†Ø·Ù‚Ø© Ù…ØªÙˆØ§Ø²Ù†Ø© Ø³ÙŠØ¯ÙŠ
    const zones = [];
    const names = ["Ø§Ù„Ø«ÙˆØ±Ø©", "Ø§Ù„Ø´Ù…ÙˆØ®", "Ø£Ø±ÙŠØ¯Ùˆ", "Ø§Ù„Ø³ÙƒÙƒ", "Ø³ÙˆÙ…Ø±", "Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠØ©", "Ø§Ù„Ø­Ø¨ÙˆØ¨ÙŠ", "Ø§Ù„Ø¬Ø¨Ø§ÙŠØ´", "Ø³ÙˆÙ‚ Ø§Ù„Ø´ÙŠÙˆØ®", "Ø§Ù„Ø¥Ø³ÙƒØ§Ù†"];
    for(let i=0; i<40; i++) {
        if(i === 0) zones.push({n: "Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", t: "start", i: "ğŸš©"});
        else if(i % 5 === 0) zones.push({n: "ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¸", t: "luck", i: "ğŸ“¦"});
        else zones.push({n: names[i%names.length], t: "p", p: 100 + (i*10), i: "ğŸ˜ï¸"});
    }

    function createRoom() { myRoom = document.getElementById('r-id').value; socket.emit('create_room', {room: myRoom}); joinRoom(); }
    function joinRoom() { myName = document.getElementById('p-name').value; myRoom = document.getElementById('r-id').value; socket.emit('join_game', {room: myRoom, name: myName, color: myColor}); }
    socket.on('join_success', (d) => { document.getElementById('lobby').style.display='none'; document.getElementById('game-screen').classList.remove('hidden'); renderBoard(); });

    function renderBoard() {
        const b = document.getElementById('board'); b.innerHTML = "";
        // Ù…Ù†Ø·Ù‚ ØªÙˆØ²ÙŠØ¹ 40 Ù…Ù†Ø·Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù (11x11)
        for(let i=0; i<40; i++) {
            let r, c;
            if(i<11) { r=1; c=i+1; }
            else if(i<20) { r=i-9; c=11; }
            else if(i<31) { r=11; c=31-i; }
            else { r=41-i; c=1; }
            let d = document.createElement('div'); d.className = 'cell'; d.id = 'z-' + i;
            d.style.gridRow = r; d.style.gridColumn = c;
            d.innerHTML = `<div class="owner-tag" id="tag-${i}"></div><span>${zones[i].i}</span><br>${zones[i].n}`;
            b.appendChild(d);
        }
    }

    // Ø§Ù„Ù…Ø´ÙŠ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ø³ÙŠØ¯ÙŠ
    async function moveStepByStep(playerName, targetPos, color) {
        let currentPos = playerPositions[playerName] || 0;
        while(currentPos !== targetPos) {
            currentPos = (currentPos + 1) % 40;
            updateTokenUI(playerName, currentPos, color);
            await new Promise(r => setTimeout(r, 300)); // Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø´ÙŠ
        }
        playerPositions[playerName] = targetPos;
        checkLandAction(targetPos);
    }

    function updateTokenUI(name, pos, color) {
        let oldT = document.getElementById('t-' + name);
        if(oldT) oldT.remove();
        let t = document.createElement('div'); t.className = 'token'; t.id = 't-' + name;
        t.style.background = color;
        document.getElementById('z-' + pos).appendChild(t);
    }

    function roll() { socket.emit('roll_dice', {room: myRoom}); }

    socket.on('dice_result', (data) => {
        const p = data.game.players.find(pl => pl.name === data.roller);
        moveStepByStep(p.name, p.pos, p.color);
        document.getElementById('dice-val').innerText = data.steps;
    });

    socket.on('update_game', (game) => {
        game.players.forEach(p => {
            if(!playerPositions[p.name]) updateTokenUI(p.name, p.pos, p.color);
            if(p.name === myName) document.getElementById('money-info').innerText = "ğŸ’° " + p.money + "$";
        });
        // ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø³ÙŠØ¯ÙŠ
        for(let pos in game.properties) {
            const owner = game.players.find(pl => pl.name === game.properties[pos]);
            if(owner) document.getElementById('tag-'+pos).style.background = owner.color;
        }
        const turnP = game.players[game.turn];
        document.getElementById('roll-btn').disabled = (turnP.name !== myName);
    });

    function checkLandAction(pos) {
        if(myName !== document.getElementById('turn-txt').innerText.split(': ')[1]) return;
        const zone = zones[pos];
        if(zone.t === 'p') {
            // Ù‡Ù†Ø§ ÙŠØ¸Ù‡Ø± Ø®ÙŠØ§Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ù…Ù„ÙˆÙƒØ© (ØªÙ… Ø´Ø±Ø­Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
        } else if(zone.t === 'luck') {
            let amount = (Math.floor(Math.random() * 5) + 1) * 50; // Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…ØªÙˆØ§Ø²Ù†
            alert(`ğŸ“¦ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¸: Ø±Ø¨Ø­Øª ${amount}$ Ø³ÙŠØ¯ÙŠ!`);
            socket.emit('update_money', {room: myRoom, name: myName, amount: amount});
        }
    }
</script>
</body>
</html>
