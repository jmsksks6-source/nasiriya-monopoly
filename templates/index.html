<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø£Ø®ÙŠØ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        body { background: #121212; color: white; font-family: 'Tajawal', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        #leaderboard { width: 98%; max-width: 600px; background: #1e272e; margin: 5px 0; padding: 8px; border-radius: 10px; border: 1px solid #34495e; }
        .player-stat { display: flex; justify-content: space-between; background: #2c3e50; padding: 6px 12px; margin: 3px 0; border-radius: 5px; font-size: 13px; border-right: 4px solid transparent; }

        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨Ø© */
        #game-container { width: 95vw; height: 95vw; max-width: 550px; max-height: 550px; position: relative; margin-top: 5px; }
        .board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); width: 100%; height: 100%; background: #cce5d6; border: 2px solid #333; }
        
        .cell { border: 0.5px solid #7f8c8d; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; background: white; color: black; padding: 0; overflow: hidden; font-size: 1.8vmin; }
        .cell-header { width: 100%; height: 20%; border-bottom: 0.5px solid #333; }
        .owner-strip { position: absolute; bottom: 0; width: 100%; height: 4px; }

        .center-box { 
            grid-column: 2 / 11; grid-row: 2 / 11; 
            background: #27ae60 url('https://upload.wikimedia.org/wikipedia/commons/e/ec/Dhi_Qar_in_Iraq.svg') no-repeat center;
            background-size: contain; display: flex; align-items: center; justify-content: center;
        }
        .center-overlay { background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; color: #f1c40f; font-size: 4vmin; font-weight: bold; }

        .token { width: 3.5vmin; height: 3.5vmin; border-radius: 50%; border: 1.5px solid #fff; position: absolute; z-index: 100; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: all 0.3s ease-out; }

        /* Ø§Ù„ØªØ­ÙƒÙ… */
        #controls-area { width: 100%; max-width: 600px; display: flex; justify-content: space-around; align-items: center; background: #2c3e50; padding: 10px; position: fixed; bottom: 0; border-radius: 15px 15px 0 0; }
        .btn { background: #e67e22; border: none; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-family: inherit; }
        .btn-trade { background: #3498db; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #2c3e50; padding: 15px; border-radius: 10px; width: 90%; max-width: 400px; }
        .prop-item { display: flex; align-items: center; font-size: 12px; margin: 2px 0; }
    </style>
</head>
<body>

<div id="lobby" style="text-align: center; margin-top: 30vh;">
    <h1 style="color:#f1c40f;">ğŸ‘‘ Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
    <input id="p-name" placeholder="Ø§Ø³Ù…Ùƒ" style="padding:12px; border-radius:8px; border:none; margin:5px;"><br>
    <input id="r-id" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" style="padding:12px; border-radius:8px; border:none; margin:5px;"><br>
    <button class="btn" onclick="start()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù…Ù„ÙƒØ©</button>
</div>

<div id="game-screen" style="display:none; width: 100%; display: flex; flex-direction: column; align-items: center;">
    <div id="leaderboard"></div>

    <div id="game-container">
        <div class="board" id="board">
            <div class="center-box"><div class="center-overlay">Ø§Ù„Ù†Ø§ØµØ±ÙŠØ©</div></div>
        </div>
    </div>

    <div id="controls-area">
        <button class="btn btn-trade" onclick="showTradeModal()">ğŸ¤ Ù…Ù‚Ø§ÙŠØ¶Ø©</button>
        <div id="dice-display" style="font-size: 7vmin; background:white; color:black; padding:5px 15px; border-radius:10px;">ğŸ²</div>
        <button class="btn" id="roll-btn" onclick="roll()">Ø§Ø±Ù…ÙŠ Ø§Ù„Ø²Ø§Ø±</button>
    </div>
</div>

<div id="trade-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#f1c40f">ğŸ’° Ø¹Ù‚Ø¯ Ù…Ù‚Ø§ÙŠØ¶Ø© Ø£Ø±Ø§Ø¶ÙŠ ÙˆØ£Ù…ÙˆØ§Ù„</h3>
        <select id="trade-target" style="width:100%; padding:8px;"></select>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <div style="flex:1">
                <small>Ø£Ù†Øª ØªØ¹Ø·ÙŠ ($):</small>
                <input type="number" id="money-give" value="0" style="width:100%">
                <div id="my-props" style="height:100px; overflow-y:auto; background:#34495e; margin-top:5px;"></div>
            </div>
            <div style="flex:1">
                <small>ØªØ·Ù„Ø¨ ($):</small>
                <input type="number" id="money-want" value="0" style="width:100%">
                <div id="target-props" style="height:100px; overflow-y:auto; background:#34495e; margin-top:5px;"></div>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:15px;">
            <button class="btn" onclick="sendTrade()">Ø¥Ø±Ø³Ø§Ù„</button>
            <button class="btn" style="background:#e74c3c" onclick="closeTrade()">Ø¥ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let myName, myRoom, myColor = '#'+Math.floor(Math.random()*16777215).toString(16);
    let gameState = null;

    const colors = { brown: '#795548', lblue: '#81d4fa', pink: '#e91e63', orange: '#ff9800', red: '#f44336', yellow: '#ffeb3b', green: '#4caf50', dblue: '#3f51b5' };
    const zones = [
        {n:"Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", t:"corner"}, {n:"Ø³ÙˆÙ‚ Ø§Ù„Ø´ÙŠÙˆØ®", g:"brown", p:60}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø§Ù„Ø¹ÙƒÙŠÙƒØ©", g:"brown", p:60}, {n:"Ø¶Ø±ÙŠØ¨Ø©", t:"tax"}, {n:"ÙƒØ±Ø§Ø¬ Ø¨ØºØ¯Ø§Ø¯", t:"station", p:200}, 
        {n:"ÙƒØ±Ù…Ø© Ø¨Ù†ÙŠ Ø³Ø¹ÙŠØ¯", g:"lblue", p:100}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø§Ù„Ø·Ø§Ø±", g:"lblue", p:100}, {n:"Ø§Ù„ÙÙ‡ÙˆØ¯", g:"lblue", p:120}, {n:"Ø³Ø¬Ù†", t:"corner"}, 
        {n:"Ø­ÙŠ Ø§Ù„ÙØ¯Ø§Ø¡", g:"pink", p:140}, {n:"ÙƒÙ‡Ø±Ø¨Ø§Ø¡", t:"util", p:150}, {n:"Ø­ÙŠ Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡", g:"pink", p:140}, {n:"Ø­ÙŠ Ø§Ù„Ø´Ù…ÙˆØ®", g:"pink", p:160}, {n:"ÙƒØ±Ø§Ø¬ Ø§Ù„Ø¨ØµØ±Ø©", t:"station", p:200},
        {n:"Ø­ÙŠ Ø³ÙˆÙ…Ø±", g:"orange", p:180}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø´Ø§Ø±Ø¹ Ø¨ØºØ¯Ø§Ø¯", g:"orange", p:180}, {n:"Ø­ÙŠ Ø§Ø±ÙŠØ¯Ùˆ", g:"orange", p:200}, {n:"Ù…ÙˆÙ‚Ù", t:"corner"},
        {n:"Ø§Ù„Ø­Ø¨ÙˆØ¨ÙŠ", g:"red", p:220}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø´Ø§Ø±Ø¹ Ø§Ù„Ù†ÙŠÙ„", g:"red", p:220}, {n:"Ø§Ù„Ù…ØªÙ†Ø²Ù‡", g:"red", p:240}, {n:"Ù…Ø­Ø·Ø© Ù†Ø§ØµØ±ÙŠØ©", t:"station", p:200},
        {n:"Ù…Ø¯ÙŠÙ†Ø© Ø£ÙˆØ±", g:"yellow", p:260}, {n:"Ø§Ù„Ø²Ù‚ÙˆØ±Ø©", g:"yellow", p:260}, {n:"Ù…Ø§Ø¡", t:"util", p:150}, {n:"Ø§Ù„Ù…ØªØ­Ù", g:"yellow", p:280}, {n:"Ù„Ù„Ø³Ø¬Ù†", t:"corner"},
        {n:"Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©", g:"green", p:300}, {n:"Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø®Ù„ÙŠÙ„", g:"green", p:300}, {n:"Ø­Ø¸", t:"luck"}, {n:"Ø­ÙŠ Ø§Ù„Ù…ØªÙ†Ø²Ù‡", g:"green", p:320}, {n:"Ø§Ù„Ù‚Ø·Ø§Ø±", t:"station", p:200},
        {n:"Ø­Ø¸", t:"luck"}, {n:"Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠØ©", g:"dblue", p:350}, {n:"Ø¶Ø±ÙŠØ¨Ø©", t:"tax"}, {n:"Ø§Ù„ÙƒÙˆØ±Ù†ÙŠØ´", g:"dblue", p:400}
    ];

    function start() {
        myName = document.getElementById('p-name').value;
        myRoom = document.getElementById('r-id').value;
        if(myName && myRoom) {
            socket.emit('create_room', {room: myRoom});
            socket.emit('join_game', {room: myRoom, name: myName, color: myColor});
        }
    }

    socket.on('join_success', () => {
        document.getElementById('lobby').style.display='none';
        document.getElementById('game-screen').style.display='flex';
        buildBoard();
    });

    function buildBoard() {
        const b = document.getElementById('board');
        const center = b.querySelector('.center-box');
        b.innerHTML = ''; b.appendChild(center);
        for(let i=0; i<40; i++) {
            let z = zones[i];
            let d = document.createElement('div');
            d.className = `cell ${z.t || 'land'}`; d.id = `z-${i}`;
            let r, c;
            if(i<11) { r=11; c=11-i; } else if(i<20) { r=11-(i-10); c=1; } else if(i<31) { r=1; c=(i-20)+1; } else { r=(i-30)+1; c=11; }
            d.style.gridRow = r; d.style.gridColumn = c;
            if(z.g) d.innerHTML = `<div class="cell-header" style="background:${colors[z.g]}"></div><div class="owner-strip" id="owner-${i}"></div><span style="font-weight:bold">${z.n}</span><span>${z.p}$</span>`;
            else d.innerHTML = `<span>${z.n}</span>`;
            b.appendChild(d);
        }
    }

    function roll() { socket.emit('roll_dice', {room: myRoom}); }

    // --- Ø§Ù„Ø­Ø±ÙƒØ© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© ---
    async function moveAnimate(name, steps, currentPos) {
        let startPos = (currentPos - steps + 40) % 40;
        for(let i=1; i<=steps; i++) {
            let next = (startPos + i) % 40;
            let t = document.querySelector(`.token[data-p="${name}"]`);
            document.getElementById(`z-${next}`).appendChild(t);
            await new Promise(r => setTimeout(r, 400));
        }
    }

    socket.on('dice_result', async (data) => {
        document.getElementById('dice-display').innerText = data.steps;
        const p = data.game.players.find(pl => pl.name === data.roller);
        await moveAnimate(data.roller, data.steps, p.pos);
        if(data.roller === myName) {
            let z = zones[p.pos];
            if(z.g && !data.game.properties[p.pos]) {
                if(confirm(`ØªØ´ØªØ±ÙŠ ${z.n} Ø¨Ù€ ${z.p}$ØŸ`)) socket.emit('buy_land', {room: myRoom, name: myName, pos: p.pos, price: z.p});
            }
        }
    });

    socket.on('update_game', (game) => {
        gameState = game;
        const lb = document.getElementById('leaderboard');
        lb.innerHTML = '';
        game.players.forEach(p => {
            // Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            lb.innerHTML += `<div class="player-stat" style="border-right-color: ${p.color}">
                <span>${p.name} ${game.players[game.turn].name === p.name ? 'ğŸ²' : ''}</span>
                <span style="color:#2ecc71; font-weight:bold;">${p.money}$</span>
            </div>`;
            // Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª
            let t = document.querySelector(`.token[data-p="${p.name}"]`);
            if(!t) {
                t = document.createElement('div'); t.className = 'token';
                t.dataset.p = p.name; t.style.background = p.color;
            }
            if(!document.getElementById(`z-${p.pos}`).contains(t)) document.getElementById(`z-${p.pos}`).appendChild(t);
        });
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ùƒ
        for(let pos in game.properties) {
            let owner = game.players.find(pl => pl.name === game.properties[pos]);
            if(owner) document.getElementById(`owner-${pos}`).style.background = owner.color;
        }
        document.getElementById('roll-btn').disabled = (game.players[game.turn].id !== socket.id);
    });

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‚Ø§ÙŠØ¶Ø© ---
    function showTradeModal() {
        const sel = document.getElementById('trade-target'); sel.innerHTML = '';
        gameState.players.forEach(p => { if(p.name !== myName) sel.innerHTML += `<option value="${p.name}">${p.name}</option>`; });
        updateTradeProps();
        document.getElementById('trade-modal').style.display = 'flex';
    }
    function updateTradeProps() {
        const me = gameState.players.find(p => p.name === myName);
        const target = gameState.players.find(p => p.name === document.getElementById('trade-target').value);
        document.getElementById('my-props').innerHTML = me.owned_props.map(id => `<div class="prop-item"><input type="checkbox" class="my-p" value="${id}"> ${zones[id].n}</div>`).join('');
        if(target) document.getElementById('target-props').innerHTML = target.owned_props.map(id => `<div class="prop-item"><input type="checkbox" class="trg-p" value="${id}"> ${zones[id].n}</div>`).join('');
    }
    document.getElementById('trade-target').onchange = updateTradeProps;

    function sendTrade() {
        const offer = {
            money_give: document.getElementById('money-give').value,
            money_want: document.getElementById('money-want').value,
            props_give: Array.from(document.querySelectorAll('.my-p:checked')).map(c => c.value),
            props_want: Array.from(document.querySelectorAll('.trg-p:checked')).map(c => c.value)
        };
        socket.emit('propose_trade', {room: myRoom, from: myName, target: document.getElementById('trade-target').value, offer});
        closeTrade(); alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶!");
    }
    function closeTrade() { document.getElementById('trade-modal').style.display = 'none'; }

    socket.on('trade_received', (data) => {
        if(data.target === myName) {
            let msg = `Ø·Ù„Ø¨ Ù…Ù† ${data.from}: ÙŠØ¹Ø·ÙŠÙƒ ${data.offer.money_give}$ + ${data.offer.props_give.length} Ø£Ø±Ø¶ Ù…Ù‚Ø§Ø¨Ù„ ${data.offer.money_want}$ + ${data.offer.props_want.length} Ø£Ø±Ø¶. Ù…ÙˆØ§ÙÙ‚ØŸ`;
            if(confirm(msg)) socket.emit('respond_trade', {room: myRoom, accepted: true, from: data.from, me: myName, offer: data.offer});
        }
    });
</script>
</body>
</html>
