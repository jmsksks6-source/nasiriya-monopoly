<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÙˆÙ†ÙˆØ¨ÙˆÙ„ÙŠ Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        .hidden { display: none !important; }
        
        /* Ø§Ù„Ù„ÙˆØ­Ø© 11x11 */
        .board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); width: 98vw; height: 98vw; background: #27ae60; border: 2px solid #2ecc71; margin: 2px auto; position: relative; }
        .cell { background: #ecf0f1; border: 0.5px solid #bdc3c7; color: #2c3e50; font-size: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; font-weight: bold; text-align: center; overflow: hidden; }
        .price-tag { color: #27ae60; font-size: 4px; margin-top: 1px; }
        .owner-tag { position: absolute; top: 0; width: 100%; height: 3px; z-index: 5; }
        
        /* Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø«Ø§Ø¨Øª Ø¬Ø¯Ø§Ù‹ */
        .board-center { 
            grid-column: 2 / 11; 
            grid-row: 2 / 11; 
            background-color: #27ae60;
            /* ØµÙˆØ±Ø© Ø²Ø®Ø±ÙÙŠØ© Ø£Ùˆ Ø®Ø±ÙŠØ·Ø© ÙƒØ®Ù„ÙÙŠØ© */
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/Dhi_Qar_in_Iraq.svg'); 
            background-size: 50%;
            background-repeat: no-repeat;
            background-position: center;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            opacity: 0.9;
        }
        .center-text { background: rgba(255,255,255,0.9); padding: 5px 15px; border-radius: 10px; color: #c0392b; font-size: 14px; font-weight: bold; margin-top: 80px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .token { width: 10px; height: 10px; border-radius: 50%; border: 1.5px solid white; position: absolute; z-index: 100; transition: all 0.3s ease; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        
        /* Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠ */
        #controls { background: #2c3e50; padding: 8px; display: flex; justify-content: space-around; align-items: center; border-top: 3px solid #e67e22; position: fixed; bottom: 0; width: 100%; z-index: 1000; box-sizing: border-box; height: 80px; }
        .dice-btn { background: #e67e22; padding: 10px 25px; border-radius: 8px; font-weight: bold; border: none; color: white; font-size: 14px; box-shadow: 0 3px #a35400; }
        .dice-btn:active { transform: translateY(2px); }
        .dice-val { font-size: 28px; background: white; color: #333; padding: 2px 12px; border-radius: 6px; border: 2px solid #e67e22; }
        .shake { animation: shake 0.4s infinite; }
        @keyframes shake { 0% { transform: rotate(0); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } 100% { transform: rotate(0); } }
    </style>
</head>
<body>

<div id="lobby" style="text-align: center; padding-top: 80px;">
    <h1 style="color: #e67e22;">ğŸ›ï¸ Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
    <input id="p-name" placeholder="Ø§Ø³Ù…Ùƒ Ø³ÙŠØ¯ÙŠ" style="padding: 10px; border-radius: 5px; border: none;">
    <input id="r-id" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" style="padding: 10px; border-radius: 5px; border: none;">
    <br><br>
    <button onclick="start()" style="padding: 10px 40px; background: #e67e22; color: white; border: none; border-radius: 5px; font-weight: bold;">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="game-screen" class="hidden">
    <div class="board" id="board">
        <div class="board-center">
            <div class="center-text">Ø°ÙŠ Ù‚Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ©</div>
        </div>
    </div>
    <div id="controls">
        <div style="text-align: right;">
            <div id="money-info" style="color: #2ecc71; font-size: 18px; font-weight: bold;">ğŸ’° 2000$</div>
            <div id="msg-log" style="font-size: 8px; color: #ecf0f1; max-width: 150px; white-space: nowrap; overflow: hidden;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ...</div>
        </div>
        <div id="dice-box" class="dice-val">ğŸ²</div>
        <button id="roll-btn" class="dice-btn" onclick="roll()">Ø§Ø±Ù…ÙŠ Ø§Ù„Ø²Ø§Ø±</button>
    </div>
</div>

<script>
    const socket = io();
    let myRoom, myName, myColor = '#' + Math.floor(Math.random()*16777215).toString(16);
    let playerPositions = {};

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ù„ÙŠØ·Ø§Ø¨Ù‚ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³ÙŠØ±ÙØ± (30 = Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø³Ø¬Ù†)
    const names = ["Ø§Ù„Ø«ÙˆØ±Ø©", "Ø§Ù„Ø´Ù…ÙˆØ®", "Ø£Ø±ÙŠØ¯Ùˆ", "Ø§Ù„Ø³ÙƒÙƒ", "Ø³ÙˆÙ…Ø±", "Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠØ©", "Ø§Ù„Ø­Ø¨ÙˆØ¨ÙŠ", "Ø§Ù„Ø¬Ø¨Ø§ÙŠØ´", "Ø³ÙˆÙ‚ Ø§Ù„Ø´ÙŠÙˆØ®", "Ø§Ù„Ø¥Ø³ÙƒØ§Ù†", "Ø£ÙˆØ±", "Ø§Ù„ÙÙ‡ÙˆØ¯", "Ø§Ù„Ù†ØµØ±", "Ø§Ù„Ø±ÙØ§Ø¹ÙŠ", "Ø§Ù„Ø´Ø·Ø±Ø©", "Ø§Ù„ØºØ¯ÙŠØ±"];
    const zones = [];
    for(let i=0; i<40; i++) {
        if(i === 0) zones.push({n: "Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", t: "start", i: "ğŸš©", p: 0});
        else if(i === 10) zones.push({n: "Ø³Ø¬Ù† Ø§Ù„Ø­ÙˆØª", t: "jail", i: "â›“ï¸", p: 0}); // Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø³Ø¬Ù†
        else if(i === 20) zones.push({n: "Ù…ÙˆØ§Ù‚Ù Ù…Ø¬Ø§Ù†ÙŠØ©", t: "park", i: "ğŸ…¿ï¸", p: 0});
        else if(i === 30) zones.push({n: "Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø³Ø¬Ù†!", t: "to_jail", i: "ğŸ‘®", p: 0}); // Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ø³Ø¬Ù†
        else if(i % 5 === 0) zones.push({n: "Ø­Ø¸", t: "luck", i: "ğŸ“¦", p: 0});
        else zones.push({n: names[i%names.length], t: "p", p: 100 + (i*10), i: "ğŸ˜ï¸"});
    }

    function start() {
        myRoom = document.getElementById('r-id').value;
        myName = document.getElementById('p-name').value;
        if(!myRoom || !myName) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© Ø³ÙŠØ¯ÙŠ");
        socket.emit('create_room', {room: myRoom});
        socket.emit('join_game', {room: myRoom, name: myName, color: myColor});
    }

    socket.on('join_success', () => {
        document.getElementById('lobby').style.display='none';
        document.getElementById('game-screen').classList.remove('hidden');
        renderBoard();
    });

    function renderBoard() {
        const b = document.getElementById('board');
        // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²
        const center = b.querySelector('.board-center');
        b.innerHTML = "";
        b.appendChild(center);

        for(let i=0; i<40; i++) {
            let r, c;
            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø¹ÙƒØ³ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø©)
            if(i<11) { r=11; c=11-i; } // Ø§Ù„ØµÙ Ø§Ù„Ø³ÙÙ„ÙŠ: ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
            else if(i<20) { r=11-(i-10); c=1; } // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: ØªØ­Øª Ù„ÙÙˆÙ‚
            else if(i<30) { r=1; c=(i-20)+1; } // Ø§Ù„ØµÙ Ø§Ù„Ø¹Ù„ÙˆÙŠ: ÙŠØ³Ø§Ø± Ù„ÙŠÙ…ÙŠÙ†
            else { r=(i-30)+1; c=11; } // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: ÙÙˆÙ‚ Ù„ØªØ­Øª

            let d = document.createElement('div'); d.className = 'cell'; d.id = 'z-' + i;
            d.style.gridRow = r; d.style.gridColumn = c;
            d.innerHTML = `<div class="owner-tag" id="tag-${i}"></div><span>${zones[i].i}</span><div style="transform: scale(0.7)">${zones[i].n}</div><div class="price-tag">${zones[i].p ? zones[i].p+'$' : ''}</div>`;
            b.appendChild(d);
        }
    }

    function roll() {
        document.getElementById('dice-box').classList.add('shake');
        socket.emit('roll_dice', {room: myRoom});
    }

    socket.on('dice_result', async (data) => {
        const p = data.game.players.find(pl => pl.name === data.roller);
        document.getElementById('dice-box').classList.remove('shake');
        document.getElementById('dice-box').innerText = data.steps;
        
        let currentPos = playerPositions[p.name] || 0;
        // Ø§Ù„Ù…Ø´ÙŠ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©
        if(p.jail_turns === 0 || (p.pos !== 10 && currentPos !== 10)) {
            for(let i=0; i<data.steps; i++) {
                currentPos = (currentPos + 1) % 40;
                updateUI(p.name, currentPos, p.color);
                await new Promise(r => setTimeout(r, 200));
            }
        }
        
        // Ø§Ù„Ù‚ÙØ² Ù„Ù„Ø³Ø¬Ù† Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù‚Ø¨Ø¶ Ø¹Ù„ÙŠÙ‡
        if(p.pos === 10 && data.game.turn !== p.turn) { // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‚Ù„ ÙØ¬Ø£Ø© Ù„Ù„Ø³Ø¬Ù†
             updateUI(p.name, 10, p.color);
        }

        playerPositions[p.name] = p.pos;
        if(data.roller === myName) checkAction(p.pos, data.game);
    });

    socket.on('log', (data) => {
        document.getElementById('msg-log').innerText = data.msg;
        document.getElementById('msg-log').style.color = '#e74c3c';
        setTimeout(() => document.getElementById('msg-log').style.color = '#ecf0f1', 2000);
    });

    function updateUI(name, pos, color) {
        let old = document.getElementById('t-' + name); if(old) old.remove();
        let t = document.createElement('div'); t.className = 'token'; t.id = 't-' + name;
        t.style.background = color;
        document.getElementById('z-' + pos).appendChild(t);
    }

    function checkAction(pos, game) {
        const zone = zones[pos];
        if(zone.t === 'p' && !game.properties[pos]) {
            if(confirm(`Ù‡Ù„ ØªØ´ØªØ±ÙŠ ${zone.n} Ø¨Ù€ ${zone.p}$ØŸ`)) {
                socket.emit('buy_land', {room: myRoom, name: myName, price: zone.p, land_name: zone.n});
            }
        } else if(zone.t === 'luck') {
            let win = (Math.floor(Math.random()*5)+1)*50;
            alert(`ğŸ“¦ Ø±Ø¨Ø­Øª ${win}$ Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚!`);
            socket.emit('update_money', {room: myRoom, name: myName, amount: win});
        }
    }

    socket.on('update_game', (game) => {
        game.players.forEach(p => {
            if(!playerPositions[p.name]) updateUI(p.name, p.pos, p.color); // Ø±Ø³Ù… Ø£ÙˆÙ„ÙŠ
            if(p.name === myName) {
                document.getElementById('money-info').innerText = "ğŸ’° " + p.money + "$";
                document.getElementById('roll-btn').disabled = (game.players[game.turn].name !== myName);
                if(game.players[game.turn].name === myName) {
                    document.getElementById('msg-log').innerText = "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† Ø³ÙŠØ¯ÙŠ!";
                } else {
                    document.getElementById('msg-log').innerText = "Ø§Ù„Ø¯ÙˆØ± Ø¹Ù†Ø¯: " + game.players[game.turn].name;
                }
            }
        });
        for(let pos in game.properties) {
            const owner = game.players.find(pl => pl.name === game.properties[pos]);
            if(owner) document.getElementById('tag-'+pos).style.background = owner.color;
        }
    });
</script>
</body>
</html>
